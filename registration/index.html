<!DOCTYPE html>
<html lang="ru">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>регестрация</title>
	<style>
		* {
			outline: none;
		}

		input {
			border-color: inherit;
			border-radius: 4px;
			margin-top: 10px;
		}
	</style>
</head>

<body>
	<form action="registration.php" method="POST" class="registration">
		<div class="registration__login">
			<label for="login">Enter your login: </label>
			<input type="text" name="login" id="login" minlength="6" maxlength="32" required>
		</div>
		<div class="registration__email">
			<label for="email">Enter your email: </label>
			<input type="email" name="email" id="email" maxlength="128" required>
		</div>
		<div class="registration__password">
			<label for="password">Enter your password: </label>
			<input type="password" name="password" id="password" minlength="6" maxlength="128" required>
		</div>
		<div class="registration__repeat-password">
			<label for="repeat-password">repeat your password: </label>
			<input type="password" id="repeat-password" minlength="6" maxlength="128" required></div>
		<div class="registration-enter">
			<input type="submit" value="registration" class="registration-enter__go">
		</div>
	</form>
	<script>
		let form = {
			form: document.querySelector('form.registration'),
			login: document.querySelector('#login'),
			email: document.querySelector('#email'),
			pass: document.querySelector('#password'),
			passr: document.querySelector('#repeat-password'),
			timer: 0,
			loginCheck: false,
			passCheck: false,
			emailCheck: false,
			// функция для проверки доп. пароля
			checkPassword: function () {
				this.pass.minLength = "6";
				this.passr.minLength = "6";
				this.pass.maxLength = "128";
				this.passr.maxLength = "128";
				this.passCheck = false;
				// поля не должны быть пустыми
				if (this.pass.value != "" || this.passr.value != "") {
					// сравниваем пароли и проверяем символы
					if (this.pass.value == this.passr.value) {
						this.passr.style.borderColor = "green"; // показываем что пароли совпали
						this.passCheck = true; // разрешаем отпрвку формы
					}
					else {
						this.passr.style.borderColor = "red"; // показываем что пароли не совпали
						this.passCheck = false; // запрещаем отпрвку формы
					}
				}
				// если поля пусты, востанавливаем цвет в исходный
				else {
					this.passr.style.borderColor = "inherit";
					this.passCheck = false;
				}
			},
			// функция для проверки логина
			checkLogin: function () {
				this.login.minLength = 6;
				this.login.maxLength = 32;
				this.loginCheck = false;
				// востанавливаем цвет, если длина логина меньше 6
				if (this.login.value.length < this.login.minLength) this.login.style.borderColor = "inherit";
				if (/[\W]/.test(this.login.value)) this.login.style.borderColor = "red"; // найден не цифробуквенный символ
				// проверяем минимальное колличество символов и их корректность для поля login
				if (this.login.value.length >= this.login.minLength && !/\W/.test(this.login.value)) {
					let t = 600; // добавочное время
					// проверяем чтобы после нажатия на клавишу проходило минимум t врямя
					if (this.timer <= t) {
						this.timer += t; // добавляем время
					}
					this.login.style.borderColor = "#ff0"; // цвет ожидание проверки
					// запускаем таймер
					setTimeout(() => {
						// отнимаем добавочное время t от общего таймера, только если число таймера больше или равно добавочному
						// для предотвращение двойного срабатывания
						if (this.timer >= t) {
							this.timer -= t;
							// если таймер истёк и поле "login" имеет хотябы минимальное колличество символов, запускаем проверку логина.
							if (this.timer == 0 && this.login.value.length >= this.login.minLength) {
								let login = new XMLHttpRequest();
								login.open("GET", "loginCheck.php?login=" + this.login.value, false); // отправляем логин на проверку
								login.addEventListener("readystatechange", () => {
									// доп проверка на случай особого случая
									if (login.readyState = 4 && login.status == 200 && !/\W/.test(this.login.value)) {
										this.loginCheck = !Boolean(Number(JSON.parse(login.responseText)['respons']));  // получаем true если логин свободен и false если нет
										// меняем цвет поля login
										if (this.loginCheck) this.login.style.borderColor = "green"; // логин свободен
										else this.login.style.borderColor = "red"; // логин занят
									}
								});
								login.send();
							}
						}
					}, this.timer);
				}
			},
			// функция для проверки email
			checlEmail: function () {
				this.emailCheck = false;
				this.email.maxLength = 128;
				if (form.email.validity.valid) {
					let email = new XMLHttpRequest();
					email.open("GET", "emailCheck.php?email=" + this.email.value, false); // отправляем логин на проверку
					email.addEventListener("readystatechange", () => {
						if (email.readyState = 4 && email.status == 200) {
							this.emailCheck = !Boolean(Number(JSON.parse(email.responseText)['respons']));  // получаем true если логин свободен и false если нет
							// меняем цвет поля email
							if (this.emailCheck) this.email.style.borderColor = "green"; // логин свободен
							else this.email.style.borderColor = "red"; // логин занят
						}
					});
					email.send();
				}
				else if (this.email.value.length != 0) {
					this.email.style.borderColor = "yellow";
				}
				else {
					this.email.style.borderColor = "inherit";
				}
			}
		}
		// запускаем проверки
		form.pass.oninput = () => { form.checkPassword() }
		form.passr.oninput = () => { form.checkPassword() }
		form.login.oninput = () => { form.checkLogin() }
		form.email.oninput = () => { form.checlEmail() }
		form.form.onclick = () => { form.email.type = "email" }
		form.form.onsubmit = () => {
			if (form.passCheck && form.emailCheck && form.loginCheck && form.email.type == "email") return true;
			else return false;
		}
	</script>
</body>

</html>